# Visual FaQtory Configuration v0.5.6-beta
# ═══════════════════════════════════════════════════════════════════════════════
#
# Clean base configuration — paragraph_story + ComfyUI + reinject default ON
#
# Pipeline: story.txt → sliding window → ComfyUI (txt2img/img2img/img2vid)
#           → finalizer (stitch → 60fps → 1080p → audio mux)
#           → save to worqspace/saved-runs/<project-name>
#
# ═══════════════════════════════════════════════════════════════════════════════

# ═══════════════════════════════════════════════════════════════════════════════
# PATHS
# ═══════════════════════════════════════════════════════════════════════════════
paths:
  output_dir: ./run                 # Current run artifacts
  briqs_dir: ./run/briqs            # Per-cycle JSON state

# ═══════════════════════════════════════════════════════════════════════════════
# INPUT CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════
#
# Input modes:
#   text  — Prompt only (txt2img → img2vid per cycle)
#   image — Base image from worqspace/base_images/ (img2img → img2vid)
#   video — Extract frame from worqspace/base_video/ → treat as image mode
#   auto  — Auto-detect: video > image > text
#
# After cycle 0, pipeline chains: last frame → reinject img2img → img2vid
# ═══════════════════════════════════════════════════════════════════════════════
input:
  mode: text                        # auto | text | image | video

# ═══════════════════════════════════════════════════════════════════════════════
# BACKEND CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════
#
# ComfyUI is the only supported production backend.
# Mock backend available for testing (generates placeholder files).
# ═══════════════════════════════════════════════════════════════════════════════
backend:
  type: comfyui
  api_url: http://localhost:8188
  # workflow_image: null             # Uses default SDXL workflow
  # workflow_video: null             # Uses default SVD workflow
  # workflow_morph: null             # Uses default morph workflow
  timeout: 600
  width: 1024
  height: 576

comfyui:
  sdxl_ckpt: juggernautXL_ragnarokBy.safetensors
  svd_ckpt: svd_xt_1_1.safetensors

# ─── LoRA Configuration ──────────────────────────────────────────────────────
# LoRA injection for the ComfyUI backend. Enable and specify a .safetensors
# file to apply stylistic modifiers to the base model.
lora:
  enabled: false
  path: /path/to/your/lora.safetensors
  strength: 0.6
  backend: comfyui

# ═══════════════════════════════════════════════════════════════════════════════
# SLIDING WINDOW STORY ENGINE (paragraph_story)
# ═══════════════════════════════════════════════════════════════════════════════
#
# Reads worqspace/story.txt, splits into paragraphs, uses a rolling window
# to generate progressive visual cycles. Each cycle:
#   1. Build prompt from paragraph window
#   2. img2img keyframe from last frame (reinject mode)
#   3. img2vid from keyframe
#   4. Extract last frame for next cycle
#
# ═══════════════════════════════════════════════════════════════════════════════
paragraph_story:
  max_paragraphs: 2                 # Maximum paragraphs per window
  img2vid_duration_sec: 3           # Duration of each transition video (sec)
  img2img_denoise_min: 0.38         # Minimum denoise for img2img evolution
  img2img_denoise_max: 0.58         # Maximum denoise for img2img evolution
  video_fps: 8                      # FPS for cycle videos
  seed_base: 2222                   # Base seed for deterministic runs
  rolling_window: true
  require_morph: false              # Set true to use morph workflow

# ═══════════════════════════════════════════════════════════════════════════════
# AUDIO CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════
#
# Drop audio files into worqspace/base_audio/ — they will be auto-detected.
# Audio is muxed into the final video after all processing is complete.
#
# sync_video_audio: when true, the number of cycles is auto-computed from
# audio duration ÷ cycle_seconds (rounded up, max 2s overrun).
# ═══════════════════════════════════════════════════════════════════════════════
audio:
  enabled: true
  sync_video_audio: true           # Set true to auto-compute cycles from audio
  cycle_seconds: 3                  # Must match img2vid_duration_sec
  allow_ext:
    - wav
    - mp3
    - flac

# ═══════════════════════════════════════════════════════════════════════════════
# POST-STITCH FINALIZER (Interpolation + Upscale + Audio Mux)
# ═══════════════════════════════════════════════════════════════════════════════
#
# Runs ONCE after all cycles are complete:
#   1. Stitch all cycle videos → final_video.mp4
#   2. Interpolate to 60fps → final_video_60fps.mp4
#   3. Upscale to 1080p → final_video_60fps_1080p.mp4
#   4. Audio mux (if audio present) → final_video_60fps_1080p_audio.mp4
#   5. Save deliverable as <project-name>.mp4 in saved-runs
# ═══════════════════════════════════════════════════════════════════════════════
finalizer:
  enabled: true
  interpolate_fps: 60
  upscale_resolution: 1920x1080
  scale_algo: bicubic
  encoder_preference:
    - h264_nvenc
    - libx264
  quality:
    crf: 16
